RFC3261に準拠したステートフルなSIPプロキシを実装すること。

- INVITEおよび非INVITE要求を対象としたトランザクションをRFC3261の状態機械に従って管理する。
- トランスポート層、トランザクション層、トランザクションユーザ層を分離し、各レイヤ間はバッファ付きキューで疎結合に接続する。
- プロキシは転送時にViaヘッダの追加・削除やMax-Forwardsの減算など、基本的なSIPプロキシ処理を行う。
- 再送要求に対しては保持している応答を再送するなど、ステートフルに振る舞う。
- REGISTER要求をローカルで処理し、ユーザディレクトリに基づいたHTTP Digest認証を行うレジストラ機能を備える。未認証の要求には401/WWW-Authenticateで応答し、無効な資格情報には403、存在しないユーザには404を返す。
- レジストラはContactヘッダのexpiresパラメータや全体のExpires値を解釈し、登録バインディングの追加・更新・削除および`*`コンタクトによる解除に対応する。成功時には現在のバインディング一覧とToタグを含む200応答を生成する。
- レジストラおよびプロキシが利用するユーザディレクトリとしてSQLiteバックエンドのストアを提供し、Lookup/AllUsers API経由で資格情報と連絡先URIを取得できるようにする。テストでは専用のインメモリSQLiteドライバでCGO不要に動作させる。
- `cmd/sip-proxy`としてUDPソケットに接続する実行可能エントリポイントを提供し、`--listen`/`--upstream`/`--upstream-bind`/`--route-ttl`/`--user-db`の各フラグで構成できるようにする。`--user-db`は必須とし、`--upstream`はフォールバック用の任意指定とする。起動時にユーザDBを開いて全ユーザ情報を読み込む。
- `sip`モジュール内にSIPStackを実装し、ユーザDBの読み込みやUDPソケットの初期化、レジストラ付きプロキシとトランザクションルータの起動・停止をまとめて管理する。
- エントリポイントは受信したパケットのデコードやTTL付きルータのクリーンアップをSIPStackに委ね、シグナル処理を保持したままSIPStackの`Start`/`Stop`を指示して安全にシャットダウンする。
- 管理対象ドメイン宛ての要求はレジストラのバインディングやディレクトリに登録された連絡先URIへ直接転送し、それ以外の宛先はRequest-URIの名前解決結果を使用する。転送先が決定できない場合に限り、任意指定の`--upstream`アドレスへフォールバックする。
