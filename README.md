# xylitol4

このリポジトリには RFC 3261 に準拠したステートフルな SIP プロキシ実装が含まれます。`cmd/sip-proxy`
に配置されたエントリーポイントをビルドすることで、UDP ベースのシンプルなプロキシソフトウェアとして
起動できます。HTTP ベースのユーザ管理インタフェースも同じプロセス内で提供されます。

## ビルドと実行

```bash
go build -o sip-proxy ./cmd/sip-proxy
./sip-proxy --listen :5060 --upstream 192.0.2.10:5060 \
  --user-db ./users.db --http-listen :8080 --admin-user admin --admin-pass changeme
```

開発時にはバイナリを生成せずに `go run ./cmd/sip-proxy --upstream 192.0.2.10:5060` のように直接起動する
ことも可能です。HTTP インタフェースを有効にする場合は管理者資格情報を指定してください。

主なオプションは以下のとおりです。

- `--listen`: 下流クライアントからのパケットを受け付ける UDP アドレス (デフォルト `:5060`)
- `--upstream`: 上流の SIP サーバーに転送する UDP アドレス。省略した場合は、登録済みクライアントまたは Request-URI の名前解決に基
づいて転送先を決定します。
- `--upstream-bind`: 上流サーバーと通信する際に使用するローカル UDP アドレス (省略時は OS が割り当て)
- `--route-ttl`: クライアントのトランザクションルートを保持する時間 (デフォルト 5 分)
- `--user-db`: SIP ユーザ情報が格納された SQLite データベースファイルのパス (必須)
- `--http-listen`: ユーザ管理 Web インタフェースの待受アドレス (デフォルト `:8080`)
- `--admin-user` / `--admin-pass`: 管理画面への Basic 認証資格情報。両方を指定すると Web インタフェースが有効化されます。

プロセスは `SIGINT` または `SIGTERM` を受け取ると安全にシャットダウンします。

## ユーザ管理 Web インタフェース

同一プロセスで提供される Web UI では、以下のエンドポイントを利用できます。

- `/admin/users` … 管理者向け画面。Basic 認証で保護されており、ユーザ一覧の表示、新規登録、削除およびブロードキャストルールの管理が行えます。
- `/password` … 利用者向け画面。現在のパスワードで認証したうえで新しいパスワードを設定できます。

Web UI での操作は SIP プロキシと同じ SQLite データベースを利用するため、同じ資格情報で REGISTER 認証を行えます。`--admin-user` と
`--admin-pass` を省略すると Web インタフェースは無効化され、SIP プロキシのみが稼働します。
